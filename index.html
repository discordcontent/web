import os
import discord
from discord import app_commands, FFmpegPCMAudio
from discord.ext import commands
import asyncio
from asyncio import Queue
import youtube_dl

# ---------------- CONFIG ----------------
TOKEN = os.getenv("DISCORD_TOKEN")
ADMIN_ROLE_ID = int(os.getenv("ADMIN_ROLE_ID", 0))
LOG_CHANNEL_ID = int(os.getenv("LOG_CHANNEL_ID", 0))
DEFAULT_VC_ID = int(os.getenv("DEFAULT_VC_ID", 0))
GUILD_ID = int(os.getenv("GUILD_ID", 0))

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="/", intents=intents)
guild_queues = {}  # music queues per guild

def get_queue(guild_id):
    if guild_id not in guild_queues:
        guild_queues[guild_id] = Queue()
    return guild_queues[guild_id]

# ---------------- LOGGING ----------------
async def log_action(guild, message):
    channel = guild.get_channel(LOG_CHANNEL_ID)
    if channel:
        await channel.send(message)

# ---------------- HELPER ----------------
def is_admin(user: discord.Member):
    return any(role.id == ADMIN_ROLE_ID for role in user.roles)

# ---------------- MUSIC ----------------
ydl_opts = {
    'format': 'bestaudio/best',
    'noplaylist': True,
    'quiet': True,
}

async def play_next(ctx):
    queue = get_queue(ctx.guild.id)
    if queue.empty():
        await ctx.voice_client.disconnect()
        return
    url = await queue.get()
    with youtube_dl.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=False)
        audio_url = info['url']
    ctx.voice_client.play(FFmpegPCMAudio(audio_url), after=lambda e: asyncio.run_coroutine_threadsafe(play_next(ctx), bot.loop))

# ---------------- EVENTS ----------------
@bot.event
async def on_ready():
    await bot.tree.sync(guild=discord.Object(id=GUILD_ID))
    print(f"‚úÖ Logged in as {bot.user}")

# ---------------- SLASH COMMANDS ----------------
# ---- MUSIC ----
@bot.tree.command(name="play", description="Play YouTube audio in VC")
async def play(interaction: discord.Interaction, url: str):
    if not interaction.user.voice:
        return await interaction.response.send_message("‚ùå Join a VC first", ephemeral=True)
    channel = interaction.user.voice.channel if interaction.user.voice else interaction.guild.get_channel(DEFAULT_VC_ID)
    if not interaction.guild.voice_client:
        await channel.connect()
    queue = get_queue(interaction.guild.id)
    await queue.put(url)
    if not interaction.guild.voice_client.is_playing():
        await play_next(interaction.guild)
    await interaction.response.send_message(f"üéµ Added to queue: {url}")
    await log_action(interaction.guild, f"{interaction.user} queued {url}")

@bot.tree.command(name="pause", description="Pause the current track")
async def pause(interaction: discord.Interaction):
    vc = interaction.guild.voice_client
    if vc and vc.is_playing():
        vc.pause()
        await interaction.response.send_message("‚è∏ Paused")
        await log_action(interaction.guild, f"{interaction.user} paused playback")
    else:
        await interaction.response.send_message("‚ùå Nothing playing", ephemeral=True)

@bot.tree.command(name="resume", description="Resume paused track")
async def resume(interaction: discord.Interaction):
    vc = interaction.guild.voice_client
    if vc and vc.is_paused():
        vc.resume()
        await interaction.response.send_message("‚ñ∂Ô∏è Resumed")
        await log_action(interaction.guild, f"{interaction.user} resumed playback")
    else:
        await interaction.response.send_message("‚ùå Nothing paused", ephemeral=True)

@bot.tree.command(name="stop", description="Stop playback and clear queue")
async def stop(interaction: discord.Interaction):
    vc = interaction.guild.voice_client
    if vc:
        vc.stop()
        queue = get_queue(interaction.guild.id)
        while not queue.empty():
            await queue.get()
        await interaction.response.send_message("‚èπ Stopped and cleared queue")
        await log_action(interaction.guild, f"{interaction.user} stopped playback")
    else:
        await interaction.response.send_message("‚ùå Not in VC", ephemeral=True)

@bot.tree.command(name="queue", description="Show current queue")
async def show_queue(interaction: discord.Interaction):
    queue = get_queue(interaction.guild.id)
    if queue.empty():
        await interaction.response.send_message("üé∂ Queue is empty")
    else:
        items = list(queue._queue)
        msg = "\n".join([f"{i+1}. {url}" for i, url in enumerate(items)])
        await interaction.response.send_message(f"üé∂ Current Queue:\n{msg}")

# ---- ADMIN ----
@bot.tree.command(name="kick", description="Kick a member (admin only)")
async def kick(interaction: discord.Interaction, member: discord.Member, reason: str = "No reason"):
    if not is_admin(interaction.user):
        return await interaction.response.send_message("‚ùå Admins only", ephemeral=True)
    await member.kick(reason=reason)
    await interaction.response.send_message(f"üë¢ Kicked {member}")
    await log_action(interaction.guild, f"{interaction.user} kicked {member} ({reason})")

@bot.tree.command(name="ban", description="Ban a member (admin only)")
async def ban(interaction: discord.Interaction, member: discord.Member, reason: str = "No reason"):
    if not is_admin(interaction.user):
        return await interaction.response.send_message("‚ùå Admins only", ephemeral=True)
    await member.ban(reason=reason)
    await interaction.response.send_message(f"üî® Banned {member}")
    await log_action(interaction.guild, f"{interaction.user} banned {member} ({reason})")

@bot.tree.command(name="purge", description="Delete messages (admin only)")
async def purge(interaction: discord.Interaction, limit: int = 5):
    if not is_admin(interaction.user):
        return await interaction.response.send_message("‚ùå Admins only", ephemeral=True)
    deleted = await interaction.channel.purge(limit=limit)
    await interaction.response.send_message(f"üßπ Deleted {len(deleted)} messages", ephemeral=True)
    await log_action(interaction.guild, f"{interaction.user} purged {len(deleted)} messages in {interaction.channel}")

# ---- HELP ----
@bot.tree.command(name="help", description="Show help menu")
async def help(interaction: discord.Interaction):
    embed = discord.Embed(title="Bot Help", color=discord.Color.blurple())
    embed.add_field(name="Fun & Music", value="/play, /pause, /resume, /stop, /queue", inline=False)
    if is_admin(interaction.user):
        embed.add_field(name="Admin", value="/kick, /ban, /purge", inline=False)
    await interaction.response.send_message(embed=embed, ephemeral=True)

# ---------------- RUN ----------------
if not TOKEN:
    print("ERROR: DISCORD_TOKEN env variable not set")
else:
    bot.run(TOKEN)
